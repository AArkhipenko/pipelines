name: .NET Core Build

on:
    workflow_dispatch:
        inputs:
            dotnet_version:
                description: "Версия .NET Core"
                required: true
                default: "7.0.x"
                type: choice
                options:
                    - "7.0.x"
                    - "8.0.x"
                    - "9.0.x"
            build_type:
                description: "Тип сборки"
                required: true
                default: "build"
                type: choice
                options:
                    - build
                    - release
            branch_name:
                description: "Название ветки"
                required: true
                default: "develop"
                type: choice
                options:
                    - main
                    - develop
            repository_name:
                description: "Название репозитория (обязательно)"
                required: true
                default: AArkhipenko/user-service
                type: string
    workflow_call:
        inputs:
            dotnet_version:
                description: "Версия .NET Core"
                required: true
                default: "7.0.x"
                type: string
            build_type:
                description: "Тип сборки"
                required: true
                default: "build"
                type: string
            branch_name:
                description: "Название ветки"
                required: true
                default: "develop"
                type: string
            repository_name:
                description: "Название репозитория (обязательно)"
                required: true
                default: AArkhipenko/user-service
                type: string
        outputs:
            build_version:
                description: "Версия сборки"
                value: ${{ jobs.build.outputs.build_version }}
            docker_image:
                description: "Docker образ (только для release)"
                value: ${{ jobs.build.outputs.docker_image }}

jobs:
    build:
        runs-on: ubuntu-24.04
        outputs:
            build_version: ${{ steps.version.outputs.version }}
            docker_image: ${{ steps.docker_image.outputs.image }}

        steps:
            - name: Validate repository
              id: validate_repo
              uses: AArkhipenko/pipelines/.github/actions/validate-repository@main
              with:
                  repository_name: ${{ inputs.repository_name }}

            - name: Checkout repository
              uses: actions/checkout@v6.0.0
              with:
                  repository: ${{ inputs.repository_name }}
                  ref: ${{ inputs.branch_name }}
                  fetch-depth: 0

            - name: Setup .NET Core
              uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: ${{ inputs.dotnet_version }}

            - name: Restore dependencies
              run: dotnet restore

            - name: Build
              run: dotnet build --configuration Release --no-restore

            - name: Run tests
              run: dotnet test --configuration Release --no-build --verbosity normal

            - name: Calculate version
              id: version
              if: inputs.build_type == 'release'
              uses: AArkhipenko/pipelines/.github/actions/calculate-version@main
              with:
                  branch_name: ${{ inputs.branch_name }}
                  repository_name: ${{ inputs.repository_name }}

            - name: Publish
              if: inputs.build_type == 'release'
              run: dotnet publish --configuration Release --no-build

            - name: Prepare Docker image info
              id: docker_image
              if: inputs.build_type == 'release'
              run: |
                  IMAGE_NAME="${{ steps.validate_repo.outputs.repo_name }}"
                  IMAGE_TAG="$IMAGE_NAME:${{ steps.version.outputs.version }}"
                  echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT
                  echo "Docker image: $IMAGE_TAG"

            - name: Setup Docker Buildx
              if: inputs.build_type == 'release'
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              if: inputs.build_type == 'release'
              uses: docker/login-action@v3
              with:
                  username: ${{ vars.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push Docker image
              if: inputs.build_type == 'release'
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: |
                      ${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.validate_repo.outputs.repo_name }}-${{ steps.version.outputs.version }}
                      ${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.validate_repo.outputs.repo_name }}-latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      BUILD_VERSION=${{ steps.version.outputs.version }}

            - name: Create Git tag
              if: inputs.build_type == 'release'
              uses: AArkhipenko/pipelines/.github/actions/create-git-tag@main
              with:
                  version: ${{ steps.version.outputs.version }}
