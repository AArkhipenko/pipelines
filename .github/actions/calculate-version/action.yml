name: Calculate Version
description: Calculates version based on branch and repository
inputs:
  branch_name:
    description: Branch name
    required: true
    default: develop
  repository_name:
    description: Repository name in format owner/repo
    required: true
outputs:
  version:
    description: Calculated version
    value: ${{ steps.calculate.outputs.version }}
  v_version:
    description: Calculated version with v
    value: ${{ steps.calculate.outputs.v_version }}

runs:
  using: "composite"
  steps:
    - name: Calculate version
      id: calculate
      shell: bash
      run: |
        BRANCH_NAME="${{ inputs.branch_name }}"
        REPOSITORY_NAME="${{ inputs.repository_name }}"

        echo "üîç Calculating version for branch: $BRANCH_NAME in repository: $REPOSITORY_NAME"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ repository_name –ø–µ—Ä–µ–¥–∞–Ω –∏ –Ω–µ –ø—É—Å—Ç–æ–π
        if [ -z "$REPOSITORY_NAME" ]; then
          echo "‚ùå Error: Repository name is required but was not provided"
          exit 1
        fi

        echo "‚úÖ Using repository: $REPOSITORY_NAME"

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ –Ω–∞ —Ç–µ–∫—É—â–µ–º –∫–æ–º–º–∏—Ç–µ
        CURRENT_COMMIT=$(git rev-parse HEAD)
        TAG_ON_CURRENT_COMMIT=$(git tag --points-at HEAD)

        if [ -n "$TAG_ON_CURRENT_COMMIT" ]; then
          # –ï—Å–ª–∏ —Ç–µ–≥ –Ω–∞ —Ç–µ–∫—É—â–µ–º –∫–æ–º–º–∏—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ (–¥–ª—è –≤—Å–µ—Ö –≤–µ—Ç–æ–∫)
          VERSION="${TAG_ON_CURRENT_COMMIT#v}"
          V_VERSION="$TAG_ON_CURRENT_COMMIT"
          echo "üéØ Using tag on current commit: $VERSION"
        else
          if [ "$BRANCH_NAME" = "develop" ] || [ "$BRANCH_NAME" = "dev" ]; then
            # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø DEV –í–ï–¢–ö–ò
            echo "üîç Getting latest versions from main and dev branches..."
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ –∏–∑ –≤–µ—Ç–∫–∏ main
            MAIN_TAG=$(git ls-remote --tags "https://github.com/$REPOSITORY_NAME.git" | grep -v "{}" | grep -E "v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1 | sed 's|.*refs/tags/||')
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ –∏–∑ –≤–µ—Ç–∫–∏ develop/dev (–ª–æ–∫–∞–ª—å–Ω–æ)
            DEV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            
            if [ -z "$MAIN_TAG" ]; then
              MAIN_TAG="v0.0.0"
              echo "‚ö†Ô∏è  No main tags found in repository $REPOSITORY_NAME, using default: $MAIN_TAG"
            else
              echo "üìå Latest main tag: $MAIN_TAG"
            fi
            
            echo "üìå Latest dev tag: $DEV_TAG"
            
            # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏–∏ –∏ –≤—ã–±–∏—Ä–∞–µ–º –±–æ–ª–µ–µ —Å—Ç–∞—Ä—É—é
            compare_versions() {
              local v1="${1#v}" v2="${2#v}"
              local IFS=.
              local i ver1=($v1) ver2=($v2)
              
              for ((i=0; i<${#ver1[@]}; i++)); do
                if [[ -z ${ver2[i]} ]]; then
                  echo "1"
                  return
                fi
                if ((10#${ver1[i]} > 10#${ver2[i]})); then
                  echo "1"
                  return
                fi
                if ((10#${ver1[i]} < 10#${ver2[i]})); then
                  echo "-1"
                  return
                fi
              done
              echo "0"
            }
            
            COMPARE_RESULT=$(compare_versions "$MAIN_TAG" "$DEV_TAG")
            
            if [ "$COMPARE_RESULT" -eq "1" ]; then
              # MAIN_TAG –Ω–æ–≤–µ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º DEV_TAG (–±–æ–ª–µ–µ —Å—Ç–∞—Ä—É—é)
              BASE_TAG="$DEV_TAG"
              echo "üìä Main tag is newer, using dev tag as base: $BASE_TAG"
            elif [ "$COMPARE_RESULT" -eq "-1" ]; then
              # DEV_TAG –Ω–æ–≤–µ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º MAIN_TAG (–±–æ–ª–µ–µ —Å—Ç–∞—Ä—É—é)
              BASE_TAG="$MAIN_TAG"
              echo "üìä Dev tag is newer, using main tag as base: $BASE_TAG"
            else
              # –í–µ—Ä—Å–∏–∏ —Ä–∞–≤–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª—é–±—É—é
              BASE_TAG="$MAIN_TAG"
              echo "üìä Versions are equal, using: $BASE_TAG"
            fi
            
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º patch –≤–µ—Ä—Å–∏—é —É –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
            IFS=. read -ra VERSION_PARTS <<< "${BASE_TAG#v}"
            MAJOR=${VERSION_PARTS[0]:-0}
            MINOR=${VERSION_PARTS[1]:-0}
            PATCH=${VERSION_PARTS[2]:-0}
            
            NEW_PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
            V_VERSION="v${VERSION}"
            echo "üî¢ Increased patch version of base tag $BASE_TAG: $VERSION"
            
          elif [ "$BRANCH_NAME" = "main" ]; then
            # –õ–æ–≥–∏–∫–∞ –¥–ª—è main –≤–µ—Ç–∫–∏ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            echo "üîç Looking for latest tag on develop branch in repository: $REPOSITORY_NAME..."
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ –∏–∑ –≤–µ—Ç–∫–∏ develop —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            DEVELOP_TAG=$(git ls-remote --tags "https://github.com/$REPOSITORY_NAME.git" | grep -v "{}" | grep -E "v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1 | sed 's|.*refs/tags/||')
            
            if [ -z "$DEVELOP_TAG" ]; then
              DEVELOP_TAG="v0.0.0"
              echo "‚ö†Ô∏è  No develop tags found in repository $REPOSITORY_NAME, using default: $DEVELOP_TAG"
            else
              echo "üìå Latest develop tag in $REPOSITORY_NAME: $DEVELOP_TAG"
            fi
            
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º minor –≤–µ—Ä—Å–∏—é
            IFS=. read -ra VERSION_PARTS <<< "${DEVELOP_TAG#v}"
            MAJOR=${VERSION_PARTS[0]:-0}
            MINOR=${VERSION_PARTS[1]:-0}
            PATCH=${VERSION_PARTS[2]:-0}
            
            NEW_MINOR=$((MINOR + 1))
            VERSION="${MAJOR}.${NEW_MINOR}.0"
            V_VERSION="v${VERSION}"
            echo "üî¢ Increased minor version: $VERSION"
            
          else
            # –î–ª—è –¥—Ä—É–≥–∏—Ö –≤–µ—Ç–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É develop
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "üìå Last tag: $LAST_TAG"
            
            IFS=. read -ra VERSION_PARTS <<< "${LAST_TAG#v}"
            MAJOR=${VERSION_PARTS[0]:-0}
            MINOR=${VERSION_PARTS[1]:-0}
            PATCH=${VERSION_PARTS[2]:-0}
            
            NEW_PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
            V_VERSION="v${VERSION}"
            echo "üî¢ Increased patch version for branch $BRANCH_NAME: $VERSION"
          fi
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "v_version=$V_VERSION" >> $GITHUB_OUTPUT
        echo "‚úÖ Final version: $VERSION for repository: $REPOSITORY_NAME"